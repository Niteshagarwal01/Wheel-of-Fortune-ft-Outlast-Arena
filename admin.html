<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard — Outlast Arena 2.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="icon" type="image/png" href="logo.png" />
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #09080f;
            --bg2: #0f0e18;
            --surface: #151421;
            --accent: #f7a21d;
            --accent2: #e8571e;
            --green: #34d399;
            --white: #ffffff;
            --text: rgba(255, 255, 255, .88);
            --text-muted: rgba(255, 255, 255, .5);
            --text-dim: rgba(255, 255, 255, .3);
            --f-display: 'Outfit', sans-serif;
            --f-ui: 'Space Grotesk', sans-serif;
            --f-body: 'Inter', sans-serif;
            --r: 14px;
        }

        body {
            font-family: var(--f-body);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.65;
        }

        /* Grain */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            opacity: .025;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            background-size: 180px;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* ── Top Bar ── */
        .admin-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 36px;
            background: rgba(9, 8, 15, .8);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, .04);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .admin-brand i {
            font-size: 1.3rem;
            color: var(--accent);
        }

        .admin-brand h1 {
            font-family: var(--f-display);
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: 1px;
            color: var(--white);
        }

        .admin-brand span {
            font-family: var(--f-ui);
            font-size: .75rem;
            font-weight: 500;
            letter-spacing: 2px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .admin-back {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--f-ui);
            font-size: .8rem;
            font-weight: 500;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 8px 20px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, .08);
            transition: all .3s;
        }

        .admin-back:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        /* ── Container ── */
        .admin-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 48px 32px;
            position: relative;
            z-index: 1;
        }

        /* ── Stats Row ── */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin-bottom: 44px;
        }

        .stat-card {
            background: rgba(255, 255, 255, .03);
            border: 1px solid rgba(255, 255, 255, .05);
            border-radius: var(--r);
            padding: 28px 24px;
            text-align: center;
            transition: all .35s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, .06);
            border-color: rgba(247, 162, 29, .12);
        }

        .stat-icon {
            font-size: 1.5rem;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: var(--f-display);
            font-size: 2rem;
            font-weight: 800;
            color: var(--white);
            line-height: 1.2;
        }

        .stat-label {
            font-family: var(--f-ui);
            font-size: .72rem;
            font-weight: 600;
            letter-spacing: 2.5px;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-top: 6px;
        }

        /* ── Controls ── */
        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 50px;
            padding: 10px 20px;
            flex: 1;
            max-width: 400px;
            transition: border-color .3s;
        }

        .search-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(247, 162, 29, .08);
        }

        .search-box i {
            color: var(--text-dim);
            font-size: .85rem;
        }

        .search-box input {
            background: none;
            border: none;
            outline: none;
            color: var(--white);
            font-family: var(--f-body);
            font-size: .88rem;
            width: 100%;
        }

        .search-box input::placeholder {
            color: var(--text-dim);
        }

        .filter-btns {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            font-family: var(--f-ui);
            font-size: .76rem;
            font-weight: 600;
            letter-spacing: 1.5px;
            padding: 8px 18px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, .08);
            background: rgba(255, 255, 255, .03);
            color: var(--text-dim);
            cursor: pointer;
            transition: all .3s;
            text-transform: uppercase;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-color: transparent;
            color: #fff;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: var(--f-ui);
            font-size: .78rem;
            font-weight: 600;
            letter-spacing: 1px;
            padding: 10px 22px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all .3s;
        }

        .btn-export {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(247, 162, 29, .2);
        }

        .btn-clear {
            background: rgba(220, 50, 50, .1);
            color: #f76c6c;
            border: 1px solid rgba(220, 50, 50, .15);
        }

        .btn-clear:hover {
            background: rgba(220, 50, 50, .2);
        }

        /* ── Table ── */
        .table-container {
            background: rgba(255, 255, 255, .02);
            border: 1px solid rgba(255, 255, 255, .05);
            border-radius: var(--r);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            font-family: var(--f-ui);
            font-size: .72rem;
            font-weight: 600;
            letter-spacing: 2.5px;
            color: var(--accent);
            text-align: left;
            padding: 16px 18px;
            background: rgba(0, 0, 0, .2);
            border-bottom: 1px solid rgba(255, 255, 255, .04);
            text-transform: uppercase;
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, .03);
            transition: background .2s;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, .03);
        }

        tbody td {
            padding: 14px 18px;
            font-size: .85rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 14px;
            border-radius: 50px;
            font-family: var(--f-ui);
            font-size: .68rem;
            font-weight: 600;
            letter-spacing: 1.5px;
        }

        .badge-win {
            background: rgba(52, 211, 153, .1);
            color: var(--green);
            border: 1px solid rgba(52, 211, 153, .18);
        }

        .badge-lose {
            background: rgba(220, 50, 50, .08);
            color: #e87c7c;
            border: 1px solid rgba(220, 50, 50, .15);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-dim);
        }

        .empty-state i {
            font-size: 3rem;
            color: rgba(255, 255, 255, .1);
            margin-bottom: 16px;
            display: block;
        }

        .empty-state h3 {
            font-family: var(--f-display);
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-dim);
        }

        .empty-state p {
            font-size: .85rem;
        }

        /* ── Footer ── */
        .admin-footer {
            text-align: center;
            padding: 32px;
            border-top: 1px solid rgba(255, 255, 255, .03);
            margin-top: 48px;
        }

        .admin-footer p {
            font-family: var(--f-ui);
            font-size: .72rem;
            font-weight: 500;
            letter-spacing: 2px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* ── Responsive ── */
        @media (max-width: 768px) {
            .admin-topbar {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
            }

            .admin-container {
                padding: 28px 16px;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }

            .filter-btns {
                justify-content: center;
            }

            .table-container {
                overflow-x: auto;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <!-- Admin Login Gate -->
    <div id="adminGate"
        style="position:fixed;inset:0;z-index:99999;background:var(--bg);display:flex;align-items:center;justify-content:center;">
        <div style="text-align:center;max-width:380px;padding:40px;">
            <i class="fa-solid fa-shield-halved"
                style="font-size:2.5rem;color:var(--accent);margin-bottom:20px;display:block;"></i>
            <h2
                style="font-family:var(--f-display);font-size:1.4rem;font-weight:800;color:var(--white);margin-bottom:8px;">
                Admin Access</h2>
            <p style="font-family:var(--f-ui);font-size:.82rem;color:var(--text-dim);margin-bottom:28px;">Enter password
                to continue</p>
            <input type="password" id="adminPassInput" placeholder="Password" autofocus
                style="width:100%;padding:14px 20px;border-radius:50px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--white);font-family:var(--f-body);font-size:.95rem;outline:none;text-align:center;margin-bottom:14px;transition:border-color .3s;" />
            <button id="adminPassBtn"
                style="width:100%;padding:12px;border-radius:50px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-family:var(--f-ui);font-size:.85rem;font-weight:600;letter-spacing:1px;cursor:pointer;">
                UNLOCK
            </button>
            <p id="adminPassError"
                style="font-family:var(--f-ui);font-size:.75rem;color:#f76c6c;margin-top:14px;display:none;">Wrong
                password</p>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="admin-topbar">
        <div class="admin-brand">
            <i class="fa-solid fa-shield-halved"></i>
            <h1>Admin Dashboard</h1>
            <span>Outlast Arena 2.0</span>
        </div>
        <a href="index.html" class="admin-back">
            <i class="fa-solid fa-arrow-left"></i> Back to Site
        </a>
    </div>

    <!-- Main Content -->
    <div class="admin-container">

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
                <div class="stat-value" id="totalEntries">0</div>
                <div class="stat-label">Total Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-trophy"></i></div>
                <div class="stat-value" id="totalWins">0</div>
                <div class="stat-label">Winners</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-percent"></i></div>
                <div class="stat-value" id="totalDiscounts">0</div>
                <div class="stat-label">Discounts Given</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                <div class="stat-value" id="totalRevenue">₹0</div>
                <div class="stat-label">Expected Revenue</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-row">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Search by name or phone..." />
            </div>
            <div class="filter-btns">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="win">Winners</button>
                <button class="filter-btn" data-filter="lose">No Discount</button>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="action-btn btn-export" id="exportBtn">
                    <i class="fa-solid fa-download"></i> Export CSV
                </button>
                <button class="action-btn btn-clear" id="clearBtn">
                    <i class="fa-solid fa-trash"></i> Clear All
                </button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Reward</th>
                        <th>Fee</th>
                        <th>Type</th>
                        <th>Reward ID</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="entriesBody">
                </tbody>
            </table>
            <div class="empty-state" id="emptyState" style="display:none;">
                <i class="fa-solid fa-inbox"></i>
                <h3>No Entries Yet</h3>
                <p>Player entries will appear here once they spin the wheel.</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="admin-footer">
        <p>Wheel of Fortune ft Outlast Arena 2.0 · Utkarsh 2026</p>
    </div>

    <!-- Supabase SDK & Config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>

    <script>
        // ── Admin Password Gate ──
        (() => {
            const PASS_TEXT = 'Nitesh_OutlastArena';
            const gate = document.getElementById('adminGate');
            const input = document.getElementById('adminPassInput');
            const btn = document.getElementById('adminPassBtn');
            const err = document.getElementById('adminPassError');

            // Check if already authenticated this session
            if (sessionStorage.getItem('oa2_admin_auth') === 'true') {
                gate.style.display = 'none';
                return;
            }

            function tryLogin() {
                if (input.value === PASS_TEXT) {
                    sessionStorage.setItem('oa2_admin_auth', 'true');
                    gate.style.opacity = '0';
                    gate.style.transition = 'opacity .4s ease';
                    setTimeout(() => gate.style.display = 'none', 400);
                } else {
                    err.style.display = 'block';
                    input.style.borderColor = '#f76c6c';
                    setTimeout(() => {
                        err.style.display = 'none';
                        input.style.borderColor = 'rgba(255,255,255,.08)';
                    }, 2000);
                }
            }

            btn.addEventListener('click', tryLogin);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') tryLogin();
            });
        })();

        // ── Admin Dashboard ──
        (() => {
            'use strict';

            const KEY_PREFIX = 'oa2_entries';
            const tbody = document.getElementById('entriesBody');
            const emptyState = document.getElementById('emptyState');
            const searchInput = document.getElementById('searchInput');
            const filterBtns = document.querySelectorAll('.filter-btn');
            const exportBtn = document.getElementById('exportBtn');
            const clearBtn = document.getElementById('clearBtn');

            let currentFilter = 'all';

            function safeParse(key, fallback) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : fallback;
                } catch (e) {
                    console.error('Error parsing storage key:', key, e);
                    return fallback;
                }
            }

            async function getAllEntries() {
                // If Supabase is active, fetch from there
                if (sbClient) {
                    const { data, error } = await sbClient
                        .from('entries')
                        .select('*')
                        .order('timestamp', { ascending: false });

                    if (error) {
                        console.error('Error fetching from Supabase:', error);
                        return [];
                    }
                    console.log('Loaded entries from Supabase:', data);
                    return data;
                }

                // Fallback: LocalStorage
                const entries = [];
                const player = safeParse('oa2_player', null);
                const pass = safeParse('oa2_pass', null);

                if (player && pass) {
                    entries.push({ ...player, ...pass });
                }

                const bulk = safeParse(KEY_PREFIX, []);
                if (Array.isArray(bulk)) {
                    bulk.forEach(entry => {
                        if (!entries.find(e => e.id === entry.id)) {
                            entries.push(entry);
                        }
                    });
                }
                return entries;
            }

            function updateStats(entries) {
                document.getElementById('totalEntries').textContent = entries.length;
                const wins = entries.filter(e => e.type === 'win').length;
                document.getElementById('totalWins').textContent = wins;
                const discounts = entries.filter(e => e.discount && e.discount > 0).length;
                document.getElementById('totalDiscounts').textContent = discounts;

                const revenue = entries.reduce((sum, e) => sum + (e.fee || 100), 0);
                document.getElementById('totalRevenue').textContent = '₹' + revenue;
            }

            function renderEntries(entries) {
                const search = searchInput.value.toLowerCase().trim();
                let filtered = entries;

                if (search) {
                    filtered = filtered.filter(e =>
                        (e.name || '').toLowerCase().includes(search) ||
                        (e.phone || '').includes(search)
                    );
                }

                if (currentFilter !== 'all') {
                    filtered = filtered.filter(e => e.type === currentFilter);
                }

                tbody.innerHTML = '';

                if (filtered.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }
                emptyState.style.display = 'none';

                filtered.forEach((entry, i) => {
                    const tr = document.createElement('tr');
                    const isWin = entry.type === 'win';
                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td><strong style="color:var(--white)">${entry.name || '—'}</strong></td>
                        <td>${entry.phone || '—'}</td>
                        <td>${entry.reward || '—'}</td>
                        <td>₹${entry.fee || 100}</td>
                        <td><span class="badge ${isWin ? 'badge-win' : 'badge-lose'}">${isWin ? 'WIN' : 'NO WIN'}</span></td>
                        <td style="font-size:.75rem;opacity:.5">${entry.id || '—'}</td>
                        <td style="font-size:.75rem;opacity:.5">${entry.time || '—'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            async function refresh() {
                const entries = await getAllEntries();
                updateStats(entries);
                renderEntries(entries);
            }

            searchInput.addEventListener('input', refresh);

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    refresh();
                });
            });

            exportBtn.addEventListener('click', () => {
                const entries = getAllEntries();
                if (entries.length === 0) return alert('No entries to export.');

                const headers = ['Name', 'Phone', 'Reward', 'Fee', 'Type', 'Discount', 'Reward ID', 'Verification', 'Time'];
                const rows = entries.map(e => [
                    e.name || '', e.phone || '', e.reward || '', e.fee || 100,
                    e.type || '', e.discount || 0, e.id || '', e.code || '', e.time || ''
                ]);

                let csv = headers.join(',') + '\n';
                rows.forEach(r => {
                    csv += r.map(v => `"${v}"`).join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `outlast_arena_entries_${new Date().toISOString().slice(0, 10)}.csv`;
                a.click();
            });

            clearBtn.addEventListener('click', () => {
                if (!confirm('Are you sure? This will clear ALL saved entries from this browser.')) return;
                localStorage.removeItem('oa2_player');
                localStorage.removeItem('oa2_pass');
                localStorage.removeItem('oa2_spun');
                localStorage.removeItem(KEY_PREFIX);
                refresh();
            });

            refresh();
            // Reset Spin Logic
            const resetBtn = document.getElementById('resetSpinBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (confirm('Reset your local spin status? This allows you to spin again on this device.')) {
                        localStorage.removeItem('oa2_spun');
                        localStorage.removeItem('oa2_reward');
                        localStorage.removeItem('oa2_pass');
                        alert('Spin status reset! Go back to the wheel page and refresh.');
                    }
                });
            }

        })();
    </script>
</body>

</html>